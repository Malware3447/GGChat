<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGChat — Чаты с ИИ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1E453E; /* Темно-зеленый */
            --primary-hover: #15322C; /* Темнее зеленый */
            --background-light: #F7F7F7; /* Очень светлый фон */
            --text-dark: #1E293B;
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08);
            --border-radius-large: 16px;
            --transition-speed: 0.3s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-dark); line-height: 1.6; }
        a { text-decoration: none; color: var(--primary-color); }

        .container { display: flex; height: 100vh; }
        
        /* Навигационный бар */
        .nav-bar {
            width: 60px;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 20px;
        }
        
        .nav-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-icon.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-icon:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Левая панель - список чатов */
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary-color); }
        .create-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            border: none;
            cursor: pointer;
        }
        .create-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .search-container { padding: 15px; border-bottom: 1px solid #E2E8F0; }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .chat-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #F1F5F9;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .chat-card:hover { background-color: #F8FAFC; }
        .chat-card.active { background-color: #F1F5F9; }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-weight: 800;
            display: grid;
            place-items: center;
            margin-right: 15px;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message {
            color: #64748B;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Правая панель - окно чата */
        .chat-window {
            width: calc(100% - 360px); /* Учитываем ширину навбара и сайдбара */
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .chat-title { font-size: 20px; font-weight: 700; }
        .chat-actions { display: flex; align-items: center; gap: 10px; }
        .icon-btn {
            height: 40px;
            width: 40px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            background: #fff;
            cursor: pointer;
            transition: background var(--transition-speed), transform var(--transition-speed), border-color var(--transition-speed);
        }
        .icon-btn:hover { background: #F8FAFC; transform: translateY(-1px); border-color: #D1D5DB; }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #F8FAFC;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #fff;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative; /* Для позиционирования статуса */
        }
        .message.own {
            background: var(--primary-color);
            color: #fff;
            margin-left: auto;
        }
        .message-content {
            word-break: break-word;
            /* Добавим немного места снизу для статуса */
            margin-bottom: 20px;
        }
        
        .message-time {
            position: absolute;
            bottom: 4px;
            right: 24px; /* 18px (ширина статуса) + 6px (отступ статуса) */
            font-size: 12px;
            color: #64748B;
        }
        
        .message.own .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        .message-empty {
            text-align: center;
            color: #64748B;
            padding: 40px 20px;
        }
        
        .composer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #E2E8F0;
            background: #fff;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            font-size: 16px;
        }
        .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .send-btn:hover { background: var(--primary-hover); }
        
        /* Модальные окна */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.open { display: flex; }
        .modal {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            padding: 22px;
            transform: translateY(10px);
            opacity: 0;
            transition: opacity var(--transition-speed), transform var(--transition-speed);
        }
        .modal-backdrop.open .modal { transform: translateY(0); opacity: 1; }
        .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 14px; }
        .input-group { margin-bottom: 16px; position: relative; }
        .input-group label {
            position: absolute;
            top: 14px;
            left: 14px;
            color: #94A3B8;
            transition: 0.2s ease-out;
            pointer-events: none;
        }
        .input-group input:focus ~ label,
        .input-group input:not(:placeholder-shown) ~ label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            background-color: white;
            padding: 0 5px;
            color: var(--primary-color);
        }
        .input-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
        .btn { padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
        .btn.secondary { background: #F1F5F9; color: #0F172A; }
        .btn.primary { background: var(--primary-color); color: #fff; }
        .btn.primary:hover { background: var(--primary-hover); }
        .danger { background: #EF4444; color: #fff; }
        .danger:hover { background: #DC2626; }
        
        /* Состояния */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        .empty-state h2 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .empty-state p { color: #64748B; max-width: 400px; }
        
        @media (max-width: 1100px) {
            .container { flex-direction: column; height: auto; }
            .sidebar, .chat-window { width: 100%; height: auto; }
            .chat-window { display: none; }
            .chat-window.active { display: flex; }
        }
        
        @media (max-width: 720px) {
            .header { padding: 16px; }
            .search-container { padding: 10px; }
            .chat-card { padding: 12px 15px; }
            .avatar { width: 40px; height: 40px; margin-right: 10px; }
            .chat-name { font-size: 15px; }
            .last-message { font-size: 13px; }
            .chat-header { padding: 16px; }
            .chat-title { font-size: 18px; }
            .messages-container { padding: 15px; }
            .composer { padding: 12px 15px; }
            .message-input { padding: 10px 12px; font-size: 15px; }
            .send-btn { padding: 10px 15px; font-size: 15px; }
        }

        .message-status {
            display: none; /* Скрываем по умолчанию */
            width: 18px;
            height: 18px;
            position: absolute; /* Абсолютное позиционирование */
            bottom: 4px; /* Отступ снизу */
            right: 6px; /* Отступ справа */
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }
        
        /* Показываем статус только для .own сообщений */
        .message.own .message-status {
            display: block;
        }

        /* Иконка "Отправлено" (одна белая, т.к. фон --primary-color) */
        .message-status.status-send {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.7)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
        }

        /* Иконка "Прочитано" (две белые) */
        .message-status.status-read {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M7 13l3 3 7-7' /%3E%3Cpath d='M13 13l3 3 7-7' /%3E%3C/svg%3E");
        }

        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
        }
        .date-separator-text {
            font-size: 13px;
            font-weight: 600;
            color: #64748B; /* Тот же цвет, что и у времени */
            background-color: #F1F5F9; /* Светлый фон */
            padding: 4px 12px;
            border-radius: 20px;
        }

        .chat-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            height: 50px; /* Та же высота, что и у аватара */
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            min-width: 24px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Навигационный бар -->
    <div class="nav-bar">
        <div class="nav-icon" id="user-chats-icon" title="Чаты с пользователями">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1569C15.0783 15.392 14.0591 14.9391 13 14.9H9C7.94087 14.9 6.92172 15.392 6.17157 16.1569C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="nav-icon active" id="ai-chats-icon" title="Чаты с ИИ агентом">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9L17 14L18.18 21.02L12 17.77L5.82 21.02L7 14L2 9L8.91 8.26L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>
    <!-- Левая панель - список чатов -->
    <div class="sidebar">
        <header class="header">
            <div class="logo">GGChat</div>
            <button id="open-create" class="create-btn">Создать чат</button>
        </header>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Поиск чатов...">
        </div>
        
        <div class="chats-list" id="chats-list">
            <!-- Чаты будут добавляться сюда динамически -->
        </div>
        
        <section id="empty" class="empty-state" style="display: none;">
            <h2>Пока у вас нет чатов с ИИ</h2>
            <p>Нажмите «Создать чат», чтобы начать новый разговор с ИИ агентом.</p>
        </section>
    </div>
    
    <!-- Правая панель - окно чата -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <div class="chat-title" id="chat-title">Выберите чат</div>
            <div class="chat-actions">
                <button id="open-settings" class="icon-btn" title="Настройки">
                    <!-- simple gear icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#0F172A" stroke-width="1.5"/>
                        <path d="M19.4 13.5a7.6 7.6 0 0 0 .05-3l2.02-1.53-2-3.46-2.44.6a7.63 7.63 0 0 0-2.6-1.5L12 1.5 9.57 4.1a7.63 7.63 0 0 0-2.6 1.5l-2.44-.6-2 3.46 2.02 1.53a7.6 7.6 0 0 0 0 3L2.53 15l2 3.46 2.44-.6c.78.62 1.66 1.12 2.6 1.5L12 22.5l2.43-2.6c.94-.38 1.82-.88 2.6-1.5l2.44.6 2-3.46-2.02-1.54Z" stroke="#94A3B8" stroke-width="1.2"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="message-empty">Выберите чат, чтобы начать переписку</div>
        </div>
        <form class="composer" id="composer">
            <input id="message-input" class="message-input" type="text" placeholder="Напишите сообщение…" autocomplete="off">
            <button class="send-btn" type="submit">Отправить</button>
        </form>
    </div>
</div>

<!-- Modal create chat -->
<div id="modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-title">
        <div class="modal-title" id="create-title">Новый чат с ИИ</div>
        <form id="create-form">
                    <div class="input-group">
                        <input id="chat-name" type="text" placeholder=" " autocomplete="off" required>
                        <label for="chat-name">Название чата</label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="cancel-create" class="btn secondary">Отмена</button>
                        <button type="submit" class="btn primary">Создать</button>
                    </div>
                </form>
    </div>
        </div>
        
        <!-- Modal: settings -->
        <div id="settings-modal-backdrop" class="modal-backdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
                <div class="modal-title" id="settings-title">Настройки чата</div>
                
                <div class="modal-actions">
                    <div class="left-actions">
                        <button id="delete-chat" class="btn danger">Удалить чат</button>
                    </div>
                    <div>
                        <button id="close-settings" class="btn primary">Готово</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
    // --- Элементы DOM ---
    const openCreateBtn = document.getElementById('open-create');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const cancelCreateBtn = document.getElementById('cancel-create');
    const createForm = document.getElementById('create-form');
    const chatNameInput = document.getElementById('chat-name');
    const emptyState = document.getElementById('empty');
    const chatsList = document.getElementById('chats-list');
    const chatWindow = document.getElementById('chat-window');
    const chatTitle = document.getElementById('chat-title');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('composer');
    const messageInput = document.getElementById('message-input');
    const openSettingsBtn = document.getElementById('open-settings');
    const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
    const closeSettingsBtn = document.getElementById('close-settings');
    const deleteChatBtn = document.getElementById('delete-chat');
    
    // --- Навигационные иконки ---
    const userChatsIcon = document.getElementById('user-chats-icon');
    const aiChatsIcon = document.getElementById('ai-chats-icon');

    // --- Управление состоянием ---
    let currentChatId = null;
    let currentChatName = null;
    let currentUserId = null;
    let lastDisplayedDate = null;

    // --- Вспомогательные функции ---

    /**
     * Читает cookie по имени. Мы используем это для получения JWT-токена.
     */
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    /**
     * Форматирует дату для отображения в разделителе.
     * @param {Date} date - Объект Date
     * @returns {string} - Например, "8 ноября"
     */
    function formatDateForSeparator(date) {
        // 'ru-RU' для получения названий месяцев на русском, как в примере
        const options = { day: 'numeric', month: 'long' };
        return date.toLocaleDateString('ru-RU', options);
    }

    /**
     * Декодирует JWT-токен из cookie, чтобы получить ID текущего пользователя.
     * Это нужно, чтобы правильно отображать 'свои' (own) сообщения.
     */
    function getUserIdFromToken() {
        if (currentUserId) return currentUserId; // Возвращаем из кэша

        const token = getCookie('UserToken');
        if (!token) {
            console.error('Не удалось найти UserToken, перенаправление на вход...');
            // Раскомментируй это, когда аутентификация будет готова
            // window.location.href = '../../autentifications/index.html';
            return null;
        }
        try {
            // Декодируем 'payload' (вторую часть) токена
            const payloadBase64 = token.split('.')[1];
            const decodedPayload = atob(payloadBase64.replace(/-/g, '+').replace(/_/g, '/'));
            const payload = JSON.parse(decodedPayload);

            // 'UserId' - это то, как мы назвали его в 'jwt.go'
            if (!payload.UserId) {
                console.error('UserId не найден в JWT-токене');
                return null;
            }
            
            currentUserId = payload.UserId; // Кэшируем ID
            return currentUserId;
        } catch (e) {
            console.error('Ошибка декодирования JWT:', e);
            return null;
        }
    }

    // --- Логика работы с чатами ---

    /**
     * Загружает список чатов с ИИ (REST).
     */
    async function loadAIChats() {
        try {
            const response = await fetch('/api/v1/ai_chats/all_chats', {
                credentials: 'include'
            });
            
            if (response.status === 401) {
                console.error('Ошибка 401 при загрузке чатов');
                // Раскомментируй для редиректа
                // window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                const chats = await response.json();
                
                if (!chats || chats.length === 0) {
                    displayAIChats([]);
                } else {
                    displayAIChats(chats);
                }
            } else {
                console.error('Ошибка при загрузке чатов:', response.status);
                displayAIChats([]);
            }
        } catch (error) {
            console.error('Ошибка при загрузке чатов:', error);
            displayAIChats([]);
        }
    }

    /**
     * Отображает список чатов с ИИ.
     */
    function displayAIChats(chats) {
        if (!chats || chats.length === 0) {
            emptyState.style.display = 'flex';
            chatsList.innerHTML = '';
            return;
        }
        
        emptyState.style.display = 'none';
        chatsList.innerHTML = '';
        
        chats.forEach(chat => {
            let lastMsgText = "Нет сообщений";
            
            if (chat.last_message) {
                lastMsgText = chat.last_message;
                if (lastMsgText.length > 35) {
                    lastMsgText = lastMsgText.substring(0, 35) + '...';
                }
            }
            
            const unreadBadge = chat.unread_count > 0 
                ? `<div class="unread-badge">${chat.unread_count}</div>` 
                : '';
            
            const chatCardHTML = `
                <div class="avatar">${chat.title.charAt(0).toUpperCase()}</div>
                <div class="chat-info">
                    <div class="chat-name">${chat.title}</div>
                    <div class="last-message">${lastMsgText}</div>
                </div>
                <div class="chat-status">
                    ${unreadBadge}
                </div>
            `;
            
            const chatCard = document.createElement('div');
            chatCard.className = 'chat-card';
            chatCard.id = `chat-card-${chat.id}`;
            chatCard.innerHTML = chatCardHTML;
            
            chatCard.addEventListener('click', () => {
                document.querySelectorAll('.chat-card').forEach(card => {
                    card.classList.remove('active');
                });
                chatCard.classList.add('active');
                loadChat(chat.id, chat.title);
            });
            
            chatsList.appendChild(chatCard);
        });
    }

    /**
     * Загружает ВЫБРАННЫЙ чат.
     */
    async function loadChat(chatId, chatName) {
        currentChatId = chatId;
        currentChatName = chatName;
        
        chatTitle.textContent = chatName;
        chatWindow.classList.add('active');
        
        // Загружаем историю сообщений
        await loadMessages(chatId);
    }

    /**
     * Загружает историю сообщений (REST).
     */
    async function loadMessages(chatId) {
        if (!chatId) {
            messagesContainer.innerHTML = '<div class="message-empty">Не выбран чат</div>';
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/ai_chats/messages/${chatId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const messages = await response.json();
                displayMessages(messages);
            } else {
                messagesContainer.innerHTML = '<div class="message-empty">Ошибка загрузки сообщений</div>';
            }
        } catch (error) {
            console.error('Ошибка при загрузке сообщений:', error);
            messagesContainer.innerHTML = '<div class="message-empty">Ошибка загрузки сообщений</div>';
        }
    }

    /**
     * Отображает ИСТОРИЮ сообщений.
     */
    function displayMessages(messages) {
        messagesContainer.innerHTML = '';
        lastDisplayedDate = null;
        
        if (!messages || messages.length === 0) {
            messagesContainer.innerHTML = '<div class="message-empty">Сообщений пока нет.</div>';
            return;
        }
        
        messages.forEach(message => {
            appendMessageToChat(message);
        });
        
        // Обновляем превью чата в списке
        if (messages.length > 0) {
            updateChatListPreview(currentChatId, messages[messages.length - 1].content);
        }
    }

    function updateChatListPreview(chatId, newText) {
        const chatCard = document.getElementById(`chat-card-${chatId}`);
        if (chatCard) {
            const lastMsgElement = chatCard.querySelector('.last-message');
            if (lastMsgElement) {
                let content = newText;
                if (content.length > 35) {
                    content = content.substring(0, 35) + '...';
                }
                lastMsgElement.textContent = content;
            }
            // Убираем счетчик, т.к. чат очевидно прочитан (он открыт)
            const badge = chatCard.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    }

    /**
     * Добавляет одно сообщение в DOM.
     */
    function appendMessageToChat(message) {
        // Убираем "пустое" сообщение, если оно есть
        const emptyMsg = messagesContainer.querySelector('.message-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        const messageDate = message.sent_at;
        if (messageDate) {
            const date = new Date(messageDate);
            // Получаем строку YYYY-MM-DD для простого сравнения
            const messageDateStr = date.toISOString().split('T')[0];

            // Сравниваем с последней сохраненной датой
            if (messageDateStr !== lastDisplayedDate) {
                // Если даты не совпадают, создаем и вставляем разделитель
                const separator = document.createElement('div');
                separator.className = 'date-separator';
                separator.innerHTML = `<span class="date-separator-text">${formatDateForSeparator(date)}</span>`;
                messagesContainer.appendChild(separator);
                
                // Обновляем трекер
                lastDisplayedDate = messageDateStr;
            }
        }

        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        // Определяем, наше ли это сообщение
        if (message.sender_type === "user") {
            messageElement.classList.add('own');
        }
        
        // Добавляем время отправки сообщения
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        
        // Получаем время из сообщения
        const messageTime = message.sent_at;
        if (messageTime) {
            // Преобразуем в объект Date, если это строка
            const date = new Date(messageTime);
            // Форматируем время в ЧЧ:ММ
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            timeDiv.textContent = `${hours}:${minutes}`;
        } else {
            // Если время не указано, показываем прочерк
            timeDiv.textContent = '--:--';
        }
        
        messageElement.appendChild(timeDiv);
        
        // Для "own" сообщений добавляем статус
        if (message.sender_type === "user") {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message-status status-read';
            messageElement.appendChild(statusDiv);
        }
        
        // Используем textContent для безопасности
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = message.content;
        messageElement.appendChild(content);
        
        messagesContainer.appendChild(messageElement);
        
        // Прокручиваем к последнему сообщению
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // --- Обработчики событий ---

    /**
     * Отправка сообщения.
     */
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        
        if (!content || !currentChatId) {
            console.warn('Не могу отправить сообщение...');
            return;
        }
        
        try {
            const response = await fetch('/api/v1/ai_chats/new_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    chat_id: currentChatId,
                    content: content
                })
            });
            
            if (response.ok) {
                const message = await response.json();
                appendMessageToChat(message);
                messageInput.value = '';
                
                // Загружаем обновленный список чатов
                await loadAIChats();
            } else {
                console.error('Ошибка при отправке сообщения:', response.status);
            }
        } catch (error) {
            console.error('Ошибка при отправке сообщения:', error);
        }
    });
    
    /**
     * Инициализация страницы.
     */
    document.addEventListener('DOMContentLoaded', async () => {
        // Получаем ID пользователя
        currentUserId = getUserIdFromToken();
        
        // Загружаем список чатов с ИИ
        await loadAIChats();
    });

    // --- Навигация между типами чатов ---
    userChatsIcon.addEventListener('click', function() {
        // Перенаправление на страницу чатов с пользователями
        window.location.href = '../all_chats/allchat.html';
    });
    
    // --- Модальные окна ---
    
    // Создание чата
    openCreateBtn.addEventListener('click', () => {
        modalBackdrop.classList.add('open');
        chatNameInput.focus();
    });

    function closeCreateModal() {
        modalBackdrop.classList.remove('open');
        createForm.reset();
    }

    cancelCreateBtn.addEventListener('click', closeCreateModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeCreateModal();
    });

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const chatName = chatNameInput.value.trim();
        if (!chatName) return;
        
        try {
            const response = await fetch('/api/v1/ai_chats/new_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ title: chatName })
            });
            
            if (response.status === 401) {
                window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                closeCreateModal();
                await loadAIChats(); // Обновляем список чатов
            } else {
                console.error('Ошибка при создании чата:', response.status);
            }
        } catch (error) {
            console.error('Ошибка при создании чата:', error);
        }
    });

    // Настройки чата
    openSettingsBtn.addEventListener('click', () => {
        if (!currentChatId) {
            alert('Сначала выберите чат');
            return;
        }
        settingsModalBackdrop.style.display = 'flex';
        const modal = settingsModalBackdrop.querySelector('.modal');
        setTimeout(() => modal.classList.add('open'), 10);
    });

    function closeSettingsModal() {
        const modal = settingsModalBackdrop.querySelector('.modal');
        modal.classList.remove('open');
        setTimeout(() => settingsModalBackdrop.style.display = 'none', 250);
    }

    closeSettingsBtn.addEventListener('click', closeSettingsModal);
    settingsModalBackdrop.addEventListener('click', (e) => {
        if (e.target === settingsModalBackdrop) closeSettingsModal();
    });

    // Удаление чата
    deleteChatBtn.addEventListener('click', async () => {
        if (!currentChatId) return;
        if (!confirm('Вы уверены, что хотите удалить этот чат? Это действие нельзя отменить.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/ai_chats/delete_chat/${currentChatId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                closeSettingsModal();
                chatWindow.classList.remove('active');
                currentChatId = null;
                await loadAIChats(); // Обновляем список
            } else {
                console.error('Ошибка при удалении чата:', response.status);
                alert('Ошибка при удалении чата');
            }
        } catch (error) {
            console.error('Ошибка при удалении чата:', error);
            alert('Ошибка при удалении чата');
        }
    });
</script>

</body>
</html>