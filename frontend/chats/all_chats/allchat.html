<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGChat — Ваши чаты</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1E453E; /* Темно-зеленый */
            --primary-hover: #15322C; /* Темнее зеленый */
            --background-light: #F7F7F7; /* Очень светлый фон */
            --text-dark: #1E293B;
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08);
            --border-radius-large: 16px;
            --transition-speed: 0.3s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-dark); line-height: 1.6; }
        a { text-decoration: none; color: var(--primary-color); }

        .container { display: flex; height: 100vh; }
        
        /* Левая панель - список чатов */
        .sidebar {
            width: 33.33%;
            background-color: white;
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary-color); }
        .create-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            border: none;
            cursor: pointer;
        }
        .create-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .search-container { padding: 15px; border-bottom: 1px solid #E2E8F0; }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .chat-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #F1F5F9;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .chat-card:hover { background-color: #F8FAFC; }
        .chat-card.active { background-color: #F1F5F9; }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-weight: 800;
            display: grid;
            place-items: center;
            margin-right: 15px;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message {
            color: #64748B;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Правая панель - окно чата */
        .chat-window {
            width: 66.66%;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .chat-title { font-size: 20px; font-weight: 700; }
        .chat-actions { display: flex; align-items: center; gap: 10px; }
        .icon-btn {
            height: 40px;
            width: 40px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            background: #fff;
            cursor: pointer;
            transition: background var(--transition-speed), transform var(--transition-speed), border-color var(--transition-speed);
        }
        .icon-btn:hover { background: #F8FAFC; transform: translateY(-1px); border-color: #D1D5DB; }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #F8FAFC;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #fff;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .message.own {
            background: var(--primary-color);
            color: #fff;
            margin-left: auto;
        }
        .message-content { word-break: break-word; }
        .message-empty {
            text-align: center;
            color: #64748B;
            padding: 40px 20px;
        }
        
        .composer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #E2E8F0;
            background: #fff;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            font-size: 16px;
        }
        .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .send-btn:hover { background: var(--primary-hover); }
        
        /* Модальные окна */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.open { display: flex; }
        .modal {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            padding: 22px;
            transform: translateY(10px);
            opacity: 0;
            transition: opacity var(--transition-speed), transform var(--transition-speed);
        }
        .modal-backdrop.open .modal { transform: translateY(0); opacity: 1; }
        .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 14px; }
        .input-group { margin-bottom: 16px; position: relative; }
        .input-group label {
            position: absolute;
            top: 14px;
            left: 14px;
            color: #94A3B8;
            transition: 0.2s ease-out;
            pointer-events: none;
        }
        .input-group input:focus ~ label,
        .input-group input:not(:placeholder-shown) ~ label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            background-color: white;
            padding: 0 5px;
            color: var(--primary-color);
        }
        .input-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
        .btn { padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
        .btn.secondary { background: #F1F5F9; color: #0F172A; }
        .btn.primary { background: var(--primary-color); color: #fff; }
        .btn.primary:hover { background: var(--primary-hover); }
        .danger { background: #EF4444; color: #fff; }
        .danger:hover { background: #DC2626; }
        
        /* Состояния */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        .empty-state h2 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .empty-state p { color: #64748B; max-width: 400px; }
        
        @media (max-width: 1100px) {
            .container { flex-direction: column; height: auto; }
            .sidebar, .chat-window { width: 100%; height: auto; }
            .chat-window { display: none; }
            .chat-window.active { display: flex; }
        }
        
        @media (max-width: 720px) {
            .header { padding: 16px; }
            .search-container { padding: 10px; }
            .chat-card { padding: 12px 15px; }
            .avatar { width: 40px; height: 40px; margin-right: 10px; }
            .chat-name { font-size: 15px; }
            .last-message { font-size: 13px; }
            .chat-header { padding: 16px; }
            .chat-title { font-size: 18px; }
            .messages-container { padding: 15px; }
            .composer { padding: 12px 15px; }
            .message-input { padding: 10px 12px; font-size: 15px; }
            .send-btn { padding: 10px 15px; font-size: 15px; }
        }

    </style>
</head>
<body>

<div class="container">
    <!-- Левая панель - список чатов -->
    <div class="sidebar">
        <header class="header">
            <div class="logo">GGChat</div>
            <button id="open-create" class="create-btn">Создать чат</button>
        </header>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Поиск чатов...">
        </div>
        
        <div class="chats-list" id="chats-list">
            <!-- Чаты будут добавляться сюда динамически -->
        </div>
        
        <section id="empty" class="empty-state" style="display: none;">
            <h2>Пока у вас нет чатов</h2>
            <p>Нажмите «Создать чат», чтобы начать новый разговор. Вы сможете добавить собеседников позже.</p>
        </section>
    </div>
    
    <!-- Правая панель - окно чата -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <div class="chat-title" id="chat-title">Выберите чат</div>
            <div class="chat-actions">
                <button id="open-settings" class="icon-btn" title="Настройки">
                    <!-- simple gear icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#0F172A" stroke-width="1.5"/>
                        <path d="M19.4 13.5a7.6 7.6 0 0 0 .05-3l2.02-1.53-2-3.46-2.44.6a7.63 7.63 0 0 0-2.6-1.5L12 1.5 9.57 4.1a7.63 7.63 0 0 0-2.6 1.5l-2.44-.6-2 3.46 2.02 1.53a7.6 7.6 0 0 0 0 3L2.53 15l2 3.46 2.44-.6c.78.62 1.66 1.12 2.6 1.5L12 22.5l2.43-2.6c.94-.38 1.82-.88 2.6-1.5l2.44.6 2-3.46-2.02-1.54Z" stroke="#94A3B8" stroke-width="1.2"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="message-empty">Выберите чат, чтобы начать переписку</div>
        </div>
        
        <form class="composer" id="composer">
            <input id="message-input" class="message-input" type="text" placeholder="Напишите сообщение…" autocomplete="off">
            <button class="send-btn" type="submit">Отправить</button>
        </form>
    </div>
</div>

<!-- Modal create chat -->
<div id="modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-title">
        <div class="modal-title" id="create-title">Новый чат</div>
        <form id="create-form">
                    <div class="input-group">
                        <input id="chat-name" type="text" placeholder=" " autocomplete="off" required>
                        <label for="chat-name">Название чата</label>
                    </div>
                    <div class="input-group">
                        <input id="user-name" type="text" placeholder=" " autocomplete="off" required>
                        <label for="user-name">Имя пользователя</label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="cancel-create" class="btn secondary">Отмена</button>
                        <button type="submit" class="btn primary">Создать</button>
                    </div>
                </form>
    </div>
        </div>
        
        <!-- Modal: settings -->
        <div id="settings-modal-backdrop" class="modal-backdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
                <div class="modal-title" id="settings-title">Настройки чата</div>
                
                <div class="modal-actions">
                    <div class="left-actions">
                        <button id="delete-chat" class="btn danger">Удалить чат</button>
                    </div>
                    <div>
                        <button id="close-settings" class="btn primary">Готово</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
    // --- Элементы DOM ---
    const openCreateBtn = document.getElementById('open-create');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const cancelCreateBtn = document.getElementById('cancel-create');
    const createForm = document.getElementById('create-form');
    const chatNameInput = document.getElementById('chat-name');
    const userNameInput = document.getElementById('user-name');
    const emptyState = document.getElementById('empty');
    const chatsList = document.getElementById('chats-list');
    const chatWindow = document.getElementById('chat-window');
    const chatTitle = document.getElementById('chat-title');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('composer');
    const messageInput = document.getElementById('message-input');
    const openSettingsBtn = document.getElementById('open-settings');
    const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
    const closeSettingsBtn = document.getElementById('close-settings');
    const deleteChatBtn = document.getElementById('delete-chat');

    // --- Управление состоянием ---
    let currentChatUuid = null;
    let currentChatName = null;
    let currentWs = null;      // Хранит *текущее* WebSocket соединение
    let currentUserId = null;  // Хранит ID *этого* пользователя

    // --- Вспомогательные функции ---

    /**
     * Читает cookie по имени. Мы используем это для получения JWT-токена.
     */
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    /**
     * Декодирует JWT-токен из cookie, чтобы получить ID текущего пользователя.
     * Это нужно, чтобы правильно отображать 'свои' (own) сообщения.
     */
    function getUserIdFromToken() {
        if (currentUserId) return currentUserId; // Возвращаем из кэша

        const token = getCookie('UserToken');
        if (!token) {
            console.error('Не удалось найти UserToken, перенаправление на вход...');
            // Раскомментируй это, когда аутентификация будет готова
            // window.location.href = '../../autentifications/index.html';
            return null;
        }
        try {
            // Декодируем 'payload' (вторую часть) токена
            const payloadBase64 = token.split('.')[1];
            const decodedPayload = atob(payloadBase64.replace(/-/g, '+').replace(/_/g, '/'));
            const payload = JSON.parse(decodedPayload);

            // 'UserId' - это то, как мы назвали его в 'jwt.go'
            if (!payload.UserId) {
                console.error('UserId не найден в JWT-токене');
                return null;
            }
            
            currentUserId = payload.UserId; // Кэшируем ID
            return currentUserId;
        } catch (e) {
            console.error('Ошибка декодирования JWT:', e);
            return null;
        }
    }

    // --- Управление WebSocket ---

    /**
     * Подключается к WebSocket для выбранного чата.
     */
    function connectWebSocket(chatUuid) {
        // 1. Закрываем старое соединение, если оно есть
        if (currentWs) {
            console.log('Закрываем старое WS-соединение...');
            currentWs.close();
            currentWs = null;
        }

        const token = getCookie('UserToken');
        if (!token) {
            alert('Ошибка аутентификации. Пожалуйста, войдите снова.');
            return;
        }

        // 2. Формируем URL с токеном в query (как мы и настроили в middleware)
        const wsUrl = `ws://localhost:8080/api/v1/chats/ws/${chatUuid}?token=${token}`;
        console.log(`Подключаемся к ${wsUrl}...`);
        
        currentWs = new WebSocket(wsUrl);

        // 3. Настраиваем обработчики
        currentWs.onopen = function(event) {
            console.log('WebSocket соединение установлено');
        };

        currentWs.onmessage = function(event) {
            const message = JSON.parse(event.data);
            console.log('Получено WS-сообщение:', message);

            // Если это новое сообщение и оно для *текущего* открытого чата
            if (message.type === 'new_message' && message.chat_id === currentChatUuid) {
                appendMessageToChat(message, getUserIdFromToken());
            }
        };

        currentWs.onerror = function(error) {
            console.error('Ошибка WebSocket:', error);
        };

        currentWs.onclose = function(event) {
            console.log('WebSocket соединение закрыто');
            // Если соединение было закрыто не по нашей воле (например, обрыв),
            // можно добавить логику переподключения.
            // Но если мы сами закрыли (currentWs = null), то не переподключаемся.
        };
    }

    // --- Логика работы с чатами ---

    /**
     * Загружает список чатов (REST). Это остается как было.
     */
    async function loadChats() {
        try {
            const response = await fetch('/api/v1/chats/all_chats', {
                credentials: 'include'
            });
            
            if (response.status === 401) {
                console.error('Ошибка 401 при загрузке чатов');
                // Раскомментируй для редиректа
                // window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                const data = await response.json();
                const chats = (data && Array.isArray(data)) ? data : (data && data.chats);
                
                if (!chats) {
                    console.error('Неожиданный формат данных:', data);
                    displayChats([]);
                } else {
                    displayChats(chats);
                }
            } else {
                console.error('Ошибка при загрузке чатов:', response.status);
                displayChats([]);
            }
        } catch (error) {
            console.error('Ошибка при загрузке чатов:', error);
            displayChats([]);
        }
    }

    /**
     * Отображает список чатов (без изменений).
     */
    function displayChats(chats) {
        if (!chats || chats.length === 0) {
            emptyState.style.display = 'flex';
            chatsList.innerHTML = '';
            return;
        }
        
        emptyState.style.display = 'none';
        chatsList.innerHTML = '';
        
        chats.forEach(chat => {
            const chatCard = document.createElement('div');
            chatCard.className = 'chat-card';
            chatCard.innerHTML = `
                <div class="avatar">${chat.name.charAt(0).toUpperCase()}</div>
                <div class="chat-info">
                    <div class="chat-name">${chat.name}</div>
                    <div class="last-message">Нажмите, чтобы открыть чат...</div>
                </div>
            `;
            
            // Обработчик клика на чат
            chatCard.addEventListener('click', () => {
                document.querySelectorAll('.chat-card').forEach(card => {
                    card.classList.remove('active');
                });
                chatCard.classList.add('active');
                
                // Загружаем чат
                loadChat(chat.uuid, chat.name);
            });
            
            chatsList.appendChild(chatCard);
        });
    }

    /**
     * Загружает ВЫБРАННЫЙ чат.
     * !! ИЗМЕНЕНО: Теперь эта функция также запускает WebSocket.
     */
    async function loadChat(chatUuid, chatName) {
        currentChatUuid = chatUuid;
        currentChatName = chatName;
        
        chatTitle.textContent = chatName;
        chatWindow.classList.add('active');
        
        // 1. Загружаем историю сообщений (один раз)
        await loadMessages(chatUuid);
        
        // 2. Подключаемся к WebSocket для real-time обновлений
        connectWebSocket(chatUuid);
    }

    /**
     * Загружает историю сообщений (REST).
     * !! ИЗМЕНЕНО: Использует ID пользователя для 'own' сообщений.
     */
    async function loadMessages(chatUuid) {
        if (!chatUuid) {
            messagesContainer.innerHTML = '<div class="message-empty">Не выбран чат</div>';
            return;
        }
        
        const userId = getUserIdFromToken(); // Получаем ID текущего пользователя
        
        try {
            const response = await fetch(`/api/v1/chats/get_message/${chatUuid}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const messages = await response.json();
                displayMessages(messages, userId);
            } else {
                console.error('Ошибка при загрузке сообщений:', response.status);
                messagesContainer.innerHTML = '<div class="message-empty">Ошибка загрузки сообщений</div>';
            }
        } catch (error) {
            console.error('Ошибка при загрузке сообщений:', error);
            messagesContainer.innerHTML = '<div class="message-empty">Ошибка загрузки сообщений</div>';
        }
    }

    /**
     * Отображает ИСТОРИЮ сообщений.
     * !! ИЗМЕНЕНО: Принимает userId.
     */
    function displayMessages(messages, currentUserId) {
        messagesContainer.innerHTML = '';
        
        if (!messages || messages.length === 0) {
            messagesContainer.innerHTML = '<div class="message-empty">Сообщений пока нет. Напишите первое сообщение ниже.</div>';
            return;
        }
        
        messages.forEach(message => {
            appendMessageToChat(message, currentUserId); // Используем новую функцию
        });
    }

    /**
     * !! НОВАЯ ФУНКЦИЯ
     * Добавляет одно сообщение в DOM.
     * Используется и для истории, и для новых WS-сообщений.
     */
    function appendMessageToChat(message, currentUserId) {
        // Убираем "пустое" сообщение, если оно есть
        const emptyMsg = messagesContainer.querySelector('.message-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        // Сравниваем ID из сообщения с ID нашего пользователя
        if (message.user_id === currentUserId) {
            messageElement.classList.add('own');
        }
        
        // Используем textContent для безопасности
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = message.content;
        messageElement.appendChild(content);
        
        messagesContainer.appendChild(messageElement);
        
        // Прокручиваем к последнему сообщению
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }


    // --- Обработчики событий ---

    /**
     * Отправка сообщения.
     * !! ИЗМЕНЕНО: Теперь использует currentWs.send() вместо fetch().
     */
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        
        // Проверяем, что есть контент И есть активное WS-соединение

        console.warn(content)
        console.warn(currentWs)
        console.warn(currentWs.readyState)

        if (!content || !currentWs || currentWs.readyState !== WebSocket.OPEN) {
            console.warn('Не могу отправить сообщение: нет контента или WS-соединение не готово.');
            return;
        }
        
        // Формируем сообщение по 'manager.go'
        const message = {
            type: 'new_message',
            content: content,
            chat_id: currentChatUuid
        };
        
        console.log(message)
        // Отправляем через WebSocket
        currentWs.send(JSON.stringify(message));
        
        // Очищаем поле ввода
        messageInput.value = '';
        
        // НЕ НУЖНО вызывать loadMessages()!
        // Сервер получит сообщение, сохранит в БД,
        // и транслирует его *обратно нам* (и всем в чате)
        // через ws.onmessage. Это и есть real-time.
    });

    /**
     * Инициализация страницы.
     * !! ИЗМЕНЕНО: Сразу получаем ID пользователя.
     */
    document.addEventListener('DOMContentLoaded', () => {
        getUserIdFromToken(); // Получаем и кэшируем ID пользователя при загрузке
        loadChats();          // Загружаем список чатов
    });

    // --- Модальные окна (без изменений) ---

    // Создание чата
    openCreateBtn.addEventListener('click', () => {
        modalBackdrop.classList.add('open');
        chatNameInput.focus();
    });

    function closeCreateModal() {
        modalBackdrop.classList.remove('open');
        createForm.reset();
    }

    cancelCreateBtn.addEventListener('click', closeCreateModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeCreateModal();
    });

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const chatName = chatNameInput.value.trim();
        const userName = userNameInput.value.trim();
        if (!chatName || !userName) return;
        
        try {
            const response = await fetch('/api/v1/chats/new_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ chat_name: chatName, user_name: userName })
            });
            
            console.log(response)

            if (response.status === 401) {
                window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                closeCreateModal();
                await loadChats(); // Обновляем список чатов
            } else {
                console.error('Ошибка при создании чата:', response.status);
            }
        } catch (error) {
            console.error('Ошибка при создании чата:', error);
        }
    });

    // Настройки чата
    openSettingsBtn.addEventListener('click', () => {
        if (!currentChatUuid) {
            alert('Сначала выберите чат');
            return;
        }
        settingsModalBackdrop.style.display = 'flex';
        const modal = settingsModalBackdrop.querySelector('.modal');
        setTimeout(() => modal.classList.add('open'), 10);
    });

    function closeSettingsModal() {
        const modal = settingsModalBackdrop.querySelector('.modal');
        modal.classList.remove('open');
        setTimeout(() => settingsModalBackdrop.style.display = 'none', 250);
    }

    closeSettingsBtn.addEventListener('click', closeSettingsModal);
    settingsModalBackdrop.addEventListener('click', (e) => {
        if (e.target === settingsModalBackdrop) closeSettingsModal();
    });

    // Удаление чата
    deleteChatBtn.addEventListener('click', async () => {
        if (!currentChatUuid) return;
        if (!confirm('Вы уверены, что хотите удалить этот чат? Это действие нельзя отменить.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/chats/delete_chat/${currentChatUuid}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                closeSettingsModal();
                chatWindow.classList.remove('active');
                currentChatUuid = null;
                if (currentWs) { // Закрываем WS-соединение удаленного чата
                    currentWs.close();
                    currentWs = null;
                }
                await loadChats(); // Обновляем список
            } else {
                console.error('Ошибка при удалении чата:', response.status);
                alert('Ошибка при удалении чата');
            }
        } catch (error) {
            console.error('Ошибка при удалении чата:', error);
            alert('Ошибка при удалении чата');
        }
    });
</script>

</body>
</html>
