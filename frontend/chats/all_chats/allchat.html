<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGChat ‚Äî –í–∞—à–∏ —á–∞—Ç—ã</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1E453E; /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π */
            --primary-hover: #15322C; /* –¢–µ–º–Ω–µ–µ –∑–µ–ª–µ–Ω—ã–π */
            --background-light: #F7F7F7; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            --text-dark: #1E293B;
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08);
            --border-radius-large: 16px;
            --transition-speed: 0.3s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-dark); line-height: 1.6; }
        a { text-decoration: none; color: var(--primary-color); }

        .container { display: flex; height: 100vh; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞—Ä */
        .nav-bar {
            width: 60px;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 20px;
        }
        
        .nav-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-icon.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-icon:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary-color); }
        .create-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            border: none;
            cursor: pointer;
        }
        .create-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .search-container { padding: 15px; border-bottom: 1px solid #E2E8F0; }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .chat-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #F1F5F9;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .chat-card:hover { background-color: #F8FAFC; }
        .chat-card.active { background-color: #F1F5F9; }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-weight: 800;
            display: grid;
            place-items: center;
            margin-right: 15px;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message {
            color: #64748B;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window {
            width: 66.66%;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }
        .chat-title { font-size: 20px; font-weight: 700; }
        .chat-actions { display: flex; align-items: center; gap: 10px; }
        .icon-btn {
            height: 40px;
            width: 40px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            background: #fff;
            cursor: pointer;
            transition: background var(--transition-speed), transform var(--transition-speed), border-color var(--transition-speed);
        }
        .icon-btn:hover { background: #F8FAFC; transform: translateY(-1px); border-color: #D1D5DB; }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #F8FAFC;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #fff;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */
        }
        .message.own {
            background: var(--primary-color);
            color: #fff;
            margin-left: auto;
        }
        .message-content {
            white-space: pre-line; 
            margin-bottom: 20px;
        }
        
        .message-time {
            position: absolute;
            bottom: 4px;
            right: 24px; /* 18px (—à–∏—Ä–∏–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞) + 6px (–æ—Ç—Å—Ç—É–ø —Å—Ç–∞—Ç—É—Å–∞) */
            font-size: 12px;
            color: #64748B;
        }
        
        .message.own .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        .message-empty {
            text-align: center;
            color: #64748B;
            padding: 40px 20px;
        }
        
        .composer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #E2E8F0;
            background: #fff;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            font-size: 16px;
        }
        .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .send-btn:hover { background: var(--primary-hover); }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.open { display: flex; }
        .modal {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            padding: 22px;
            transform: translateY(10px);
            opacity: 0;
            transition: opacity var(--transition-speed), transform var(--transition-speed);
        }
        .modal-backdrop.open .modal { transform: translateY(0); opacity: 1; }
        .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 14px; }
        .input-group { margin-bottom: 16px; position: relative; }
        .input-group label {
            position: absolute;
            top: 14px;
            left: 14px;
            color: #94A3B8;
            transition: 0.2s ease-out;
            pointer-events: none;
        }
        .input-group input:focus ~ label,
        .input-group input:not(:placeholder-shown) ~ label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            background-color: white;
            padding: 0 5px;
            color: var(--primary-color);
        }
        .input-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
        .btn { padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
        .btn.secondary { background: #F1F5F9; color: #0F172A; }
        .btn.primary { background: var(--primary-color); color: #fff; }
        .btn.primary:hover { background: var(--primary-hover); }
        .danger { background: #EF4444; color: #fff; }
        .danger:hover { background: #DC2626; }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏—è */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        .empty-state h2 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .empty-state p { color: #64748B; max-width: 400px; }
        
        @media (max-width: 1100px) {
            .container { flex-direction: column; height: auto; }
            .sidebar, .chat-window { width: 100%; height: auto; }
            .chat-window { display: none; }
            .chat-window.active { display: flex; }
        }
        
        @media (max-width: 720px) {
            .header { padding: 16px; }
            .search-container { padding: 10px; }
            .chat-card { padding: 12px 15px; }
            .avatar { width: 40px; height: 40px; margin-right: 10px; }
            .chat-name { font-size: 15px; }
            .last-message { font-size: 13px; }
            .chat-header { padding: 16px; }
            .chat-title { font-size: 18px; }
            .messages-container { padding: 15px; }
            .composer { padding: 12px 15px; }
            .message-input { padding: 10px 12px; font-size: 15px; }
            .send-btn { padding: 10px 15px; font-size: 15px; }
        }

        .message-status {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            width: 18px;
            height: 18px;
            position: absolute; /* –ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
            bottom: 4px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
            right: 6px; /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }
        
        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –¥–ª—è .own —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message.own .message-status {
            display: block;
        }

        /* –ò–∫–æ–Ω–∫–∞ "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" (–æ–¥–Ω–∞ –±–µ–ª–∞—è, —Ç.–∫. —Ñ–æ–Ω --primary-color) */
        .message-status.status-send {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.7)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
        }

        /* –ò–∫–æ–Ω–∫–∞ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" (–¥–≤–µ –±–µ–ª—ã–µ) */
        .message-status.status-read {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M7 13l3 3 7-7' /%3E%3Cpath d='M13 13l3 3 7-7' /%3E%3C/svg%3E");
        }

        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
        }
        .date-separator-text {
            font-size: 13px;
            font-weight: 600;
            color: #64748B; /* –¢–æ—Ç –∂–µ —Ü–≤–µ—Ç, —á—Ç–æ –∏ —É –≤—Ä–µ–º–µ–Ω–∏ */
            background-color: #F1F5F9; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            padding: 4px 12px;
            border-radius: 20px;
        }

        .chat-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            height: 50px; /* –¢–∞ –∂–µ –≤—ã—Å–æ—Ç–∞, —á—Ç–æ –∏ —É –∞–≤–∞—Ç–∞—Ä–∞ */
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            min-width: 24px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞—Ä -->
    <div class="nav-bar">
        <div class="nav-icon active" id="user-chats-icon" title="–ß–∞—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1569C15.0783 15.392 14.0591 14.9391 13 14.9H9C7.94087 14.9 6.92172 15.392 6.17157 16.1569C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="nav-icon" id="ai-chats-icon" title="–ß–∞—Ç—ã —Å –ò–ò –∞–≥–µ–Ω—Ç–æ–º">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9L17 14L18.18 21.02L12 17.77L5.82 21.02L7 14L2 9L8.91 8.26L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
    <div class="sidebar">
        <header class="header">
            <div class="logo">GGChat</div>
            <button id="open-create" class="create-btn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
        </header>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤...">
        </div>
        
        <div class="chats-list" id="chats-list">
            <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        
        <section id="empty" class="empty-state" style="display: none;">
            <h2>–ü–æ–∫–∞ —É –≤–∞—Å –Ω–µ—Ç —á–∞—Ç–æ–≤</h2>
            <p>–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å —á–∞—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä. –í—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –ø–æ–∑–∂–µ.</p>
        </section>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <div class="chat-title" id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div class="chat-actions">
                <button id="open-settings" class="icon-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <!-- simple gear icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#0F172A" stroke-width="1.5"/>
                        <path d="M19.4 13.5a7.6 7.6 0 0 0 .05-3l2.02-1.53-2-3.46-2.44.6a7.63 7.63 0 0 0-2.6-1.5L12 1.5 9.57 4.1a7.63 7.63 0 0 0-2.6 1.5l-2.44-.6-2 3.46 2.02 1.53a7.6 7.6 0 0 0 0 3L2.53 15l2 3.46 2.44-.6c.78.62 1.66 1.12 2.6 1.5L12 22.5l2.43-2.6c.94-.38 1.82-.88 2.6-1.5l2.44.6 2-3.46-2.02-1.54Z" stroke="#94A3B8" stroke-width="1.2"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="message-empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É</div>
        </div>
        <form class="composer" id="composer">
            <input id="message-input" class="message-input" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autocomplete="off">
            <button class="send-btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

<!-- Modal create chat -->
<div id="modal-backdrop" class="modal-backdrop">
<div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-title">
<div class="modal-title" id="create-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
<form id="create-form">
            <div class="input-group">
                <input id="chat-name" type="text" placeholder=" " autocomplete="off" required>
                <label for="chat-name">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</label>
            </div>
            <div class="input-group" id="user-name-group">
                <input id="user-name" type="text" placeholder=" " autocomplete="off" required>
                <label for="user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancel-create" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </form>
</div>
</div>
        
        <!-- Modal: settings -->
        <div id="settings-modal-backdrop" class="modal-backdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
                <div class="modal-title" id="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</div>
                
                <div class="modal-actions">
                    <div class="left-actions">
                        <button id="delete-chat" class="btn danger">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
                    </div>
                    <div>
                        <button id="close-settings" class="btn primary">–ì–æ—Ç–æ–≤–æ</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="crypto.js"></script>
        <script>
    // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
    const openCreateBtn = document.getElementById('open-create');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const cancelCreateBtn = document.getElementById('cancel-create');
    const createForm = document.getElementById('create-form');
    const chatNameInput = document.getElementById('chat-name');
    const userNameInput = document.getElementById('user-name');
    const emptyState = document.getElementById('empty');
    const chatsList = document.getElementById('chats-list');
    const chatWindow = document.getElementById('chat-window');
    const chatTitle = document.getElementById('chat-title');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('composer');
    const messageInput = document.getElementById('message-input');
    const openSettingsBtn = document.getElementById('open-settings');
    const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
    const closeSettingsBtn = document.getElementById('close-settings');
    const deleteChatBtn = document.getElementById('delete-chat');

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º ---
    let currentChatUuid = null;
    let currentChatName = null;
    let currentWs = null;      // –•—Ä–∞–Ω–∏—Ç *—Ç–µ–∫—É—â–µ–µ* WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    let currentUserId = null;  // –•—Ä–∞–Ω–∏—Ç ID *—ç—Ç–æ–≥–æ* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let lastDisplayedDate = null;

    let userPrivateKey = null;
    let chatPublicKeys = new Map();

    async function initCryptoAndUser() {
        // 1. –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUserId = getUserIdFromToken();
        if (!currentUserId) {
            console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            // window.location.href = '../../autentifications/index.html';
            return;
        }
        
        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏
        const { privateKey, publicKeyPEM } = await cryptoUtils.initKeys();
        userPrivateKey = privateKey; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        
        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        // (–°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –µ–≥–æ –ø—Ä–∏–Ω—è—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)
        // (–ú—ã –¥–µ–ª–∞–µ–º —ç—Ç–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ - —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –µ–≥–æ)
        try {
            await fetch('/api/v1/users/public_key', { // –≠–Ω–¥–ø–æ–∏–Ω—Ç –∏–∑ –®–∞–≥–∞ 2 (Backend)
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ public_key: publicKeyPEM })
            });
            console.log("–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä.");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:", e);
        }
    }

    async function loadChatPublicKeys(chatUuid) {
        try {
            const response = await fetch(`/api/v1/chats/public_keys/${chatUuid}`, {
                credentials: 'include'
            });
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            const keys = await response.json(); // –û–∂–∏–¥–∞–µ–º map[int]string
            
            chatPublicKeys = new Map();
            for (const userId in keys) {
                chatPublicKeys.set(parseInt(userId, 10), keys[userId]);
            }
            
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã —à–∏—Ñ—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–µ–±—è
            // (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
            const myPublicKey = localStorage.getItem("user_public_key");
            chatPublicKeys.set(currentUserId, myPublicKey);
            
            console.log("–ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", chatPublicKeys);

        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏:", e);
        }
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

    /**
     * –ß–∏—Ç–∞–µ—Ç cookie –ø–æ –∏–º–µ–Ω–∏. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT-—Ç–æ–∫–µ–Ω–∞.
     */
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ.
     * @param {Date} date - –û–±—ä–µ–∫—Ç Date
     * @returns {string} - –ù–∞–ø—Ä–∏–º–µ—Ä, "8 –Ω–æ—è–±—Ä—è"
     */
    function formatDateForSeparator(date) {
        // 'ru-RU' –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –º–µ—Å—è—Ü–µ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
        const options = { day: 'numeric', month: 'long' };
        return date.toLocaleDateString('ru-RU', options);
    }

    /**
     * –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT-—Ç–æ–∫–µ–Ω –∏–∑ cookie, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å '—Å–≤–æ–∏' (own) —Å–æ–æ–±—â–µ–Ω–∏—è.
     */
    function getUserIdFromToken() {
        if (currentUserId) return currentUserId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ –∫—ç—à–∞

        const token = getCookie('UserToken');
        if (!token) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ UserToken, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Ö–æ–¥...');
            // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ, –∫–æ–≥–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
            // window.location.href = '../../autentifications/index.html';
            return null;
        }
        try {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º 'payload' (–≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å) —Ç–æ–∫–µ–Ω–∞
            const payloadBase64 = token.split('.')[1];
            const decodedPayload = atob(payloadBase64.replace(/-/g, '+').replace(/_/g, '/'));
            const payload = JSON.parse(decodedPayload);

            // 'UserId' - —ç—Ç–æ —Ç–æ, –∫–∞–∫ –º—ã –Ω–∞–∑–≤–∞–ª–∏ –µ–≥–æ –≤ 'jwt.go'
            if (!payload.UserId) {
                console.error('UserId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ JWT-—Ç–æ–∫–µ–Ω–µ');
                return null;
            }
            
            currentUserId = payload.UserId; // –ö—ç—à–∏—Ä—É–µ–º ID
            return currentUserId;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JWT:', e);
            return null;
        }
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WebSocket ---

    /**
     * –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞.
     */
    function connectWebSocket(chatUuid) {
        // 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if (currentWs) {
            console.log('–ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
            currentWs.close();
            currentWs = null;
        }

        const token = getCookie('UserToken');
        if (!token) {
            alert('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
            return;
        }

        // 2. –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —Ç–æ–∫–µ–Ω–æ–º –≤ query (–∫–∞–∫ –º—ã –∏ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –≤ middleware)
        const wsUrl = `ws://localhost:8080/api/v1/chats/ws/${chatUuid}?token=${token}`;
        console.log(`–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ ${wsUrl}...`);
        
        currentWs = new WebSocket(wsUrl);

        // 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        currentWs.onopen = function(event) {
            console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        };

        currentWs.onmessage = async function(event) {
            const message = JSON.parse(event.data);
            console.log('–ü–æ–ª—É—á–µ–Ω–æ WS-—Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
            
            const myUserId = getUserIdFromToken();

            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–Ω–æ –¥–ª—è *—Ç–µ–∫—É—â–µ–≥–æ* –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞
            if (message.type === 'new_message' && message.chat_id === currentChatUuid) {

                try {
                // message.keys - —ç—Ç–æ map[user_id -> enc_key]
                // –ù–∞–º –Ω—É–∂–µ–Ω –∫–ª—é—á, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –ù–ê–°
                const myEncryptedKey = message.keys[currentUserId]; 
                
                const plainText = await cryptoUtils.decryptMessage(
                    message.content,     // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                    myEncryptedKey,      // –ù–∞—à –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π AES-–∫–ª—é—á
                    userPrivateKey       // –ù–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π RSA-–∫–ª—é—á
                );
                
                // –ó–ê–ú–ï–ù–Ø–ï–ú –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π
                message.content = plainText; 

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ WS-—Å–æ–æ–±—â–µ–Ω–∏—è:", e);
                message.content = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
            }
                
                // 1. –†–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                appendMessageToChat(message, myUserId);
                
                // 2. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ù–ï –æ—Ç –Ω–∞—Å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
                if (message.user_id !== myUserId && message.id) {
                    console.log(`–û—Ç–ø—Ä–∞–≤–ª—è–µ–º 'read_receipt' –¥–ª—è Message ID: ${message.id}`);
                    currentWs.send(JSON.stringify({
                        type: 'read_receipt',
                        message_id: message.id, // ID —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –ø—Ä–æ—á–∏—Ç–∞–ª–∏
                        chat_id: message.chat_id,
                        user_id: myUserId // ID —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª
                    }));
                }

                const chatCard = document.getElementById(`chat-card-${message.chat_id}`);
                if (chatCard) {
                    const lastMsgElement = chatCard.querySelector('.last-message');
                    if (lastMsgElement) {
                        let content = message.content;
                        if (content.length > 35) {
                            content = content.substring(0, 35) + '...';
                        }
                        lastMsgElement.textContent = content;
                    }
                    // –£–±–∏—Ä–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —Ç.–∫. —á–∞—Ç –æ—á–µ–≤–∏–¥–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω (–æ–Ω –æ—Ç–∫—Ä—ã—Ç)
                    const badge = chatCard.querySelector('.unread-badge');
                    if (badge) {
                        badge.remove();
                    }
                }
            
            // --- –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê ---
            } else if (message.type === 'status_update' && message.chat_id === currentChatUuid) {
                // –°–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª—Å—è
                console.log(`–ü–æ–ª—É—á–µ–Ω–æ 'status_update' –¥–ª—è Message ID: ${message.id}, –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${message.status}`);
                
                // –ù–∞–π—Ç–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM –∏ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ
                updateMessageStatusInDOM(message.id, message.status);
            }
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
        };

        currentWs.onerror = function(error) {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
        };

        currentWs.onclose = function(event) {
            console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
            // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ –Ω–µ –ø–æ –Ω–∞—à–µ–π –≤–æ–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä—ã–≤),
            // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
            // –ù–æ –µ—Å–ª–∏ –º—ã —Å–∞–º–∏ –∑–∞–∫—Ä—ã–ª–∏ (currentWs = null), —Ç–æ –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è.
        };
    }

    // --- –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–∞–º–∏ ---

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (REST). –≠—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –±—ã–ª–æ.
     */
    async function loadChats() {
        try {
            const response = await fetch('/api/v1/chats/all_chats', {
                credentials: 'include'
            });
            
            if (response.status === 401) {
                console.error('–û—à–∏–±–∫–∞ 401 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤');
                // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
                // window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                const data = await response.json();
                const chats = (data && Array.isArray(data)) ? data : (data && data.chats);
                
                if (!chats) {
                    console.error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:', data);
                    displayChats([]);
                } else {
                    await displayChats(chats);
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤:', response.status);
                displayChats([]);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤:', error);
            displayChats([]);
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π).
     */
    async function displayChats(chats) { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        if (!chats || chats.length === 0) {
            emptyState.style.display = 'flex';
            chatsList.innerHTML = '';
            return;
        }
        
        emptyState.style.display = 'none';
        chatsList.innerHTML = '';
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.all –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
        const chatPromises = chats.map(async (chat) => {
            let lastMsgText = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
            
            // –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 'last_message' (–∫–æ–Ω—Ç–µ–Ω—Ç) –∏ 'last_message_key'
            if (chat.last_message && chat.last_message_key) {
                try {
                    lastMsgText = await cryptoUtils.decryptMessage(
                        chat.last_message,
                        chat.last_message_key,
                        userPrivateKey
                    );
                } catch (e) {
                    lastMsgText = "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
                }
            } else if (chat.last_message) {
                lastMsgText = "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"; // –ö–ª—é—á –Ω–µ –ø—Ä–∏—à–µ–ª
            }
            
            if (lastMsgText.length > 35) {
                lastMsgText = lastMsgText.substring(0, 35) + '...';
            }

            const unreadBadge = chat.unread_count > 0 
                ? `<div class="unread-badge">${chat.unread_count}</div>` 
                : '';
            
            const chatCardHTML = `
                <div class="avatar">${chat.name.charAt(0).toUpperCase()}</div>
                <div class="chat-info">
                    <div class="chat-name">${chat.name}</div>
                    <div class="last-message">${lastMsgText}</div>
                </div>
                <div class="chat-status">
                    ${unreadBadge}
                </div>
            `;
            
            return {
                uuid: chat.uuid,
                name: chat.name,
                html: chatCardHTML
            };
        });
        
        const renderedChats = await Promise.all(chatPromises);
        
        // –¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –≤ DOM
        renderedChats.forEach(chatData => {
            const chatCard = document.createElement('div');
            chatCard.className = 'chat-card';
            chatCard.id = `chat-card-${chatData.uuid}`;
            chatCard.innerHTML = chatData.html;
            
            chatCard.addEventListener('click', () => {
                document.querySelectorAll('.chat-card').forEach(card => {
                    card.classList.remove('active');
                });
                chatCard.classList.add('active');
                loadChat(chatData.uuid, chatData.name);
            });
            
            chatsList.appendChild(chatCard);
        });
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–´–ë–†–ê–ù–ù–´–ô —á–∞—Ç.
     * !! –ò–ó–ú–ï–ù–ï–ù–û: –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç WebSocket.
     */
    async function loadChat(chatUuid, chatName) { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        currentChatUuid = chatUuid;
        currentChatName = chatName;
        
        chatTitle.textContent = chatName;
        chatWindow.classList.add('active');
        
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ (–Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)
        await loadChatPublicKeys(chatUuid);

        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–¥–∏–Ω —Ä–∞–∑)
        await loadMessages(chatUuid);
        
        // 3. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
        connectWebSocket(chatUuid);
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (REST).
     * !! –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è 'own' —Å–æ–æ–±—â–µ–Ω–∏–π.
     */
    async function loadMessages(chatUuid) { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        if (!chatUuid) {
            messagesContainer.innerHTML = '<div class="message-empty">–ù–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç</div>';
            return;
        }
        
        // currentUserId —É–∂–µ –µ—Å—Ç—å, getUserIdFromToken() –Ω–µ –Ω—É–∂–µ–Ω
        
        try {
            const response = await fetch(`/api/v1/chats/get_message/${chatUuid}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const messages = await response.json();
                // –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å–ª–∞—Ç—å:
                // [{ content, encrypted_key (–¥–ª—è –Ω–∞—Å), user_id, ... }]
                await displayMessages(messages, currentUserId); // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ await
            } else {
                // ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫) ...
            }
        } catch (error) {
            // ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫) ...
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ò–°–¢–û–†–ò–Æ —Å–æ–æ–±—â–µ–Ω–∏–π.
     * !! –ò–ó–ú–ï–ù–ï–ù–û: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç userId.
     */
    async function displayMessages(messages, currentUserId) { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        messagesContainer.innerHTML = '';
        lastDisplayedDate = null;
        
        if (!messages || messages.length === 0) {
            messagesContainer.innerHTML = '<div class="message-empty">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª for...of, —á—Ç–æ–±—ã `await` —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        for (const message of messages) {
            // --- –ë–õ–û–ö –†–ê–°–®–ò–§–†–û–í–ö–ò ---
            // –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å–ª–∞—Ç—å `encrypted_key` –¥–ª—è *–∫–∞–∂–¥–æ–≥–æ* —Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.encrypted_key) {
                try {
                    const plainText = await cryptoUtils.decryptMessage(
                        message.content,
                        message.encrypted_key,
                        userPrivateKey
                    );
                    message.content = plainText; // –ó–∞–º–µ–Ω—è–µ–º
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏:", message.id, e);
                    message.content = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ";
                }
            } else {
                // –ö–ª—é—á–∞ –Ω–µ—Ç (—Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—à–∏–±–∫–∞)
                message.content = "‚ö†Ô∏è –ö–ª—é—á –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω";
            }
            // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê ---

            appendMessageToChat(message, currentUserId); // –†–∏—Å—É–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if (messages.length > 0) {
             updateChatListPreview(currentChatUuid, messages[messages.length - 1].content);
        }
    }

    function updateChatListPreview(chatId, newText) {
        const chatCard = document.getElementById(`chat-card-${chatId}`);
        if (chatCard) {
            const lastMsgElement = chatCard.querySelector('.last-message');
            if (lastMsgElement) {
                let content = newText;
                if (content.length > 35) {
                    content = content.substring(0, 35) + '...';
                }
                lastMsgElement.textContent = content;
            }
            // –£–±–∏—Ä–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —Ç.–∫. —á–∞—Ç –æ—á–µ–≤–∏–¥–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω (–æ–Ω –æ—Ç–∫—Ä—ã—Ç)
            const badge = chatCard.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    }

    /**
     * !! –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
     * –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, –∏ –¥–ª—è –Ω–æ–≤—ã—Ö WS-—Å–æ–æ–±—â–µ–Ω–∏–π.
     */
    function appendMessageToChat(message, currentUserId) {
        // –£–±–∏—Ä–∞–µ–º "–ø—É—Å—Ç–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const emptyMsg = messagesContainer.querySelector('.message-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        const messageDate = message.time || message.timestamp;
        if (messageDate) {
            const date = new Date(messageDate);
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É YYYY-MM-DD –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const messageDateStr = date.toISOString().split('T')[0];

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–∞—Ç–æ–π
            if (messageDateStr !== lastDisplayedDate) {
                // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç, —Å–æ–∑–¥–∞–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                const separator = document.createElement('div');
                separator.className = 'date-separator';
                separator.innerHTML = `<span class="date-separator-text">${formatDateForSeparator(date)}</span>`;
                messagesContainer.appendChild(separator);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–∫–µ—Ä
                lastDisplayedDate = messageDateStr;
            }
        }

        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        if (message.id) {
                messageElement.dataset.messageId = message.id;
        }

        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —Å ID –Ω–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (message.user_id === currentUserId) {
            messageElement.classList.add('own');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è REST –∏ WebSocket)
        const messageTime = message.time || message.timestamp;
        if (messageTime) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –æ–±—ä–µ–∫—Ç Date, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            const date = new Date(messageTime);
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –ß–ß:–ú–ú
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            timeDiv.textContent = `${hours}:${minutes}`;
        } else {
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫ –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
            timeDiv.textContent = '--:--';
        }
        
        messageElement.appendChild(timeDiv);
        
        // –î–ª—è "own" —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if (message.user_id === currentUserId) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message-status';

            // message.status –±—É–¥–µ—Ç 'sent', 'delivered' –∏–ª–∏ 'read'
            if (message.status === 'read') {
                statusDiv.classList.add('status-read');
            } else if (message.status === 'sent' || message.status === 'delivered') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'status-send' (–æ–¥–Ω–∞ –≥–∞–ª–æ—á–∫–∞) –¥–ª—è –æ–±–æ–∏—Ö
                statusDiv.classList.add('status-send');
            }
        
            messageElement.appendChild(statusDiv);
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = message.content;
        messageElement.appendChild(content);
        
        messagesContainer.appendChild(messageElement);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateMessageStatusInDOM(messageId, newStatus) {
        const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElement) {
            return; // –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Ç –≤ DOM (–º–æ–∂–µ—Ç –±—ã—Ç—å, –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ)
        }

        let statusDiv = messageElement.querySelector('.message-status');
        if (!statusDiv) {
            // –≠—Ç–æ –Ω–µ 'own' —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ–º —Å—Ç–∞—Ç—É—Å
            return; 
        }

        // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã, —Å—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π
        statusDiv.classList.remove('status-send', 'status-read');

        if (newStatus === 'read') {
            statusDiv.classList.add('status-read');
        } else if (newStatus === 'sent' || newStatus === 'delivered') {
            statusDiv.classList.add('status-send');
        }
    }


    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.
     * !! –ò–ó–ú–ï–ù–ï–ù–û: –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç currentWs.send() –≤–º–µ—Å—Ç–æ fetch().
     * –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç—ã —Å –ò–ò.
     */
    messageForm.addEventListener('submit', async (e) => { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        e.preventDefault();
        
        const plainText = messageInput.value.trim();
        
        if (!plainText || !currentChatUuid) {
            console.warn('–ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç —á–∞—Ç–æ–º —Å –ò–ò
        if (typeof currentChatUuid === 'number') {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç —Å –ò–ò —á–µ—Ä–µ–∑ REST API
            await sendAIMessage(plainText);
        } else {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—ã—á–Ω—ã–π —á–∞—Ç —á–µ—Ä–µ–∑ WebSocket
            if (!currentWs || currentWs.readyState !== WebSocket.OPEN) {
                console.warn('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                return;
            }
            
            // --- –ë–õ–û–ö –®–ò–§–†–û–í–ê–ù–ò–Ø ---
            // `chatPublicKeys` –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
            const { content, keys } = await cryptoUtils.encryptMessage(plainText, chatPublicKeys);
            // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê ---
            
            const message = {
                type: 'new_message',
                content: content,      // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (B64)
                chat_id: currentChatUuid,
                keys: keys             // Map[user_id -> enc_key]
            };
            
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ WS-—Å–æ–æ–±—â–µ–Ω–∏—è:", message);
            currentWs.send(JSON.stringify(message));
        }
        
        messageInput.value = '';
    });
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     * !! –ò–ó–ú–ï–ù–ï–ù–û: –°—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     */
    document.addEventListener('DOMContentLoaded', async () => { // <-- –î–æ–±–∞–≤–ª–µ–Ω–æ async
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏ –ø–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await initCryptoAndUser();
        
        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω)
        await loadChats();
        
        // 3. –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á–∞—Ç–æ–≤ —Å –ò–ò, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (document.getElementById('ai-chats-icon').classList.contains('active')) {
            setupAutoRefreshAIChats();
        }
    });

    // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —á–∞—Ç–æ–≤ ---
    document.getElementById('user-chats-icon').addEventListener('click', function() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–∫–æ–Ω–∫–∏
        document.getElementById('user-chats-icon').classList.add('active');
        document.getElementById('ai-chats-icon').classList.remove('active');
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ —Å –ò–ò
        stopAutoRefreshAIChats();
        
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        loadChats();
    });
    
    document.getElementById('ai-chats-icon').addEventListener('click', function() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–∫–æ–Ω–∫–∏
        document.getElementById('ai-chats-icon').classList.add('active');
        document.getElementById('user-chats-icon').classList.remove('active');
        
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤ —Å –ò–ò
        loadAIChats();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ —Å –ò–ò
        setupAutoRefreshAIChats();
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ —Å –ò–ò
    async function loadAIChats() {
        try {
            const response = await fetch('/api/v1/ai_chats/all_chats', {
                credentials: 'include'
            });
            
            if (response.status === 401) {
                console.error('–û—à–∏–±–∫–∞ 401 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤ —Å –ò–ò');
                // window.location.href = '../../autentifications/index.html';
                return;
            }
            
            if (response.ok) {
                const chats = await response.json();
                
                if (!chats || chats.length === 0) {
                    displayAIChats([]);
                } else {
                    await displayAIChats(chats);
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤ —Å –ò–ò:', response.status);
                displayAIChats([]);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤ —Å –ò–ò:', error);
            displayAIChats([]);
        }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ —Å –ò–ò
    function setupAutoRefreshAIChats() {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (window.aiChatsRefreshInterval) {
            clearInterval(window.aiChatsRefreshInterval);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        window.aiChatsRefreshInterval = setInterval(async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á–∞—Ç–æ–≤ —Å –ò–ò
            if (document.getElementById('ai-chats-icon').classList.contains('active')) {
                await loadAIChats();
            }
        }, 5000);
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function stopAutoRefreshAIChats() {
        if (window.aiChatsRefreshInterval) {
            clearInterval(window.aiChatsRefreshInterval);
            window.aiChatsRefreshInterval = null;
        }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI —á–∞—Ç–µ
    function setupAutoRefreshAIMessages() {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (window.aiMessagesRefreshInterval) {
            clearInterval(window.aiMessagesRefreshInterval);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        window.aiMessagesRefreshInterval = setInterval(async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å –ò–ò
            if (currentChatUuid && typeof currentChatUuid === 'number') {
                await loadAIMessages(currentChatUuid);
            }
        }, 2000);
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    function stopAutoRefreshAIMessages() {
        if (window.aiMessagesRefreshInterval) {
            clearInterval(window.aiMessagesRefreshInterval);
            window.aiMessagesRefreshInterval = null;
        }
    }
    
    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å –ò–ò.
     */
    async function displayAIChats(chats) {
        if (!chats || chats.length === 0) {
            emptyState.style.display = 'flex';
            chatsList.innerHTML = '';
            // –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–æ–≤ —Å –ò–ò
            document.querySelector('#empty h2').textContent = '–ü–æ–∫–∞ —É –≤–∞—Å –Ω–µ—Ç —á–∞—Ç–æ–≤ —Å –ò–ò';
            document.querySelector('#empty p').textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å —á–∞—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ò–ò –∞–≥–µ–Ω—Ç–æ–º.';
            return;
        }
        
        emptyState.style.display = 'none';
        chatsList.innerHTML = '';
        
        chats.forEach(chat => {
            let lastMsgText = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
            
            if (chat.last_message) {
                lastMsgText = chat.last_message;
                if (lastMsgText.length > 35) {
                    lastMsgText = lastMsgText.substring(0, 35) + '...';
                }
            }
            
            const unreadBadge = chat.unread_count > 0
                ? `<div class="unread-badge">${chat.unread_count}</div>`
                : '';
            
            const chatCardHTML = `
                <div class="avatar">${chat.title.charAt(0).toUpperCase()}</div>
                <div class="chat-info">
                    <div class="chat-name">${chat.title}</div>
                </div>
                <div class="chat-status">
                    ${unreadBadge}
                </div>
            `;
            
            const chatCard = document.createElement('div');
            chatCard.className = 'chat-card';
            chatCard.id = `chat-card-${chat.id}`;
            chatCard.innerHTML = chatCardHTML;
            
            chatCard.addEventListener('click', () => {
                document.querySelectorAll('.chat-card').forEach(card => {
                    card.classList.remove('active');
                });
                chatCard.classList.add('active');
                loadAIChat(chat.id, chat.title);
            });
            
            chatsList.appendChild(chatCard);
        });
    }
    
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–´–ë–†–ê–ù–ù–´–ô —á–∞—Ç —Å –ò–ò.
     */
    async function loadAIChat(chatId, chatName) {
        currentChatUuid = chatId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –≤–º–µ—Å—Ç–æ UUID –¥–ª—è —á–∞—Ç–æ–≤ —Å –ò–ò
        currentChatName = chatName;
        
        chatTitle.textContent = chatName;
        chatWindow.classList.add('active');
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        stopAutoRefreshAIMessages();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        await loadAIMessages(chatId);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        setupAutoRefreshAIMessages();
    }
    
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ —Å –ò–ò (REST).
     */
    async function loadAIMessages(chatId) {
        if (!chatId) {
            messagesContainer.innerHTML = '<div class="message-empty">–ù–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç</div>';
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/ai_chats/messages/${chatId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const messages = await response.json();
                await displayAIMessages(messages);
            } else {
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                if (!window.aiMessagesRefreshInterval) {
                    messagesContainer.innerHTML = '<div class="message-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
            if (!window.aiMessagesRefreshInterval) {
                messagesContainer.innerHTML = '<div class="message-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            }
        }
    }
    
    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ò–°–¢–û–†–ò–Æ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ —Å –ò–ò.
     */
    async function displayAIMessages(messages) {
        // –ï—Å–ª–∏ —ç—Ç–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (window.aiMessagesRefreshInterval) {
            if (!messages || messages.length === 0) return;
            
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const existingMessages = messagesContainer.querySelectorAll('.message');
            let lastMessageId = 0;
            if (existingMessages.length > 0) {
                const lastMessage = existingMessages[existingMessages.length - 1];
                lastMessageId = parseInt(lastMessage.dataset.messageId) || 0;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const newMessages = messages.filter(msg => msg.id > lastMessageId);
            newMessages.forEach(message => {
                appendAIMessageToChat(message);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (newMessages.length > 0) {
                updateAIChatListPreview(currentChatUuid, newMessages[newMessages.length - 1].content);
            }
        } else {
            // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ (–Ω–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
            messagesContainer.innerHTML = '';
            lastDisplayedDate = null;
            
            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = '<div class="message-empty">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
                return;
            }
            
            messages.forEach(message => {
                appendAIMessageToChat(message);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
            if (messages.length > 0) {
                updateAIChatListPreview(currentChatUuid, messages[messages.length - 1].content);
            }
        }
    }
    
    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞ —Å –ò–ò –≤ DOM.
     */
    function appendAIMessageToChat(message) {
        // –£–±–∏—Ä–∞–µ–º "–ø—É—Å—Ç–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const emptyMsg = messagesContainer.querySelector('.message-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        const messageDate = message.sent_at;
        if (messageDate) {
            const date = new Date(messageDate);
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É YYYY-MM-DD –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const messageDateStr = date.toISOString().split('T')[0];

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–∞—Ç–æ–π
            if (messageDateStr !== lastDisplayedDate) {
                // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç, —Å–æ–∑–¥–∞–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                const separator = document.createElement('div');
                separator.className = 'date-separator';
                separator.innerHTML = `<span class="date-separator-text">${formatDateForSeparator(date)}</span>`;
                messagesContainer.appendChild(separator);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–∫–µ—Ä
                lastDisplayedDate = messageDateStr;
            }
        }

        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        // –î–æ–±–∞–≤–ª—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (message.id) {
            messageElement.dataset.messageId = message.id;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—à–µ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (message.sender_type === "user") {
            messageElement.classList.add('own');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageTime = message.sent_at;
        if (messageTime) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –æ–±—ä–µ–∫—Ç Date, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            const date = new Date(messageTime);
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –ß–ß:–ú–ú
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            timeDiv.textContent = `${hours}:${minutes}`;
        } else {
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫
            timeDiv.textContent = '--:--';
        }
        
        messageElement.appendChild(timeDiv);
        
        // –î–ª—è "own" —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if (message.sender_type === "user") {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message-status status-read';
            messageElement.appendChild(statusDiv);
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = message.content;
        messageElement.appendChild(content);
        
        messagesContainer.appendChild(messageElement);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function updateAIChatListPreview(chatId, newText) {
        const chatCard = document.getElementById(`chat-card-${chatId}`);
        if (chatCard) {
            const lastMsgElement = chatCard.querySelector('.last-message');
            if (lastMsgElement) {
                let content = newText;
                if (content.length > 35) {
                    content = content.substring(0, 35) + '...';
                }
                lastMsgElement.textContent = content;
            }
            // –£–±–∏—Ä–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —Ç.–∫. —á–∞—Ç –æ—á–µ–≤–∏–¥–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω (–æ–Ω –æ—Ç–∫—Ä—ã—Ç)
            const badge = chatCard.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    }
    
    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç —Å –ò–ò.
     */
    async function sendAIMessage(content) {
        try {
            const response = await fetch('/api/v1/ai_chats/new_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    chat_id: currentChatUuid,
                    content: content
                })
            });
            
            if (response.ok) {
                const message = await response.json();
                appendAIMessageToChat(message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
                updateAIChatListPreview(currentChatUuid, content);
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', response.status);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        }
    }
    
    // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        stopAutoRefreshAIChats();
    });
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
    openCreateBtn.addEventListener('click', () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π —Ç–∏–ø —á–∞—Ç–∞ –º—ã —Å–æ–∑–¥–∞–µ–º
        const isAIChat = document.getElementById('ai-chats-icon').classList.contains('active');
        
        if (isAIChat) {
            // –î–ª—è —á–∞—Ç–æ–≤ —Å –ò–ò –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            document.getElementById('user-name-group').style.display = 'none';
            document.getElementById('create-title').textContent = '–ù–æ–≤—ã–π —á–∞—Ç —Å –ò–ò';
        } else {
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —á–∞—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –ø–æ–ª—è
            document.getElementById('user-name-group').style.display = 'block';
            document.getElementById('create-title').textContent = '–ù–æ–≤—ã–π —á–∞—Ç';
        }
        
        modalBackdrop.classList.add('open');
        chatNameInput.focus();
    });

    function closeCreateModal() {
        modalBackdrop.classList.remove('open');
        createForm.reset();
    }

    cancelCreateBtn.addEventListener('click', closeCreateModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeCreateModal();
    });

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const chatName = chatNameInput.value.trim();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π —Ç–∏–ø —á–∞—Ç–∞ –º—ã —Å–æ–∑–¥–∞–µ–º
        const isAIChat = document.getElementById('ai-chats-icon').classList.contains('active');
        
        if (isAIChat) {
            // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ —Å –ò–ò
            if (!chatName) return;
            
            try {
                const response = await fetch('/api/v1/ai_chats/new_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ title: chatName })
                });
                
                if (response.status === 401) {
                    window.location.href = '../../autentifications/index.html';
                    return;
                }
                
                if (response.ok) {
                    closeCreateModal();
                    await loadAIChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å –ò–ò
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ —Å –ò–ò:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ —Å –ò–ò:', error);
            }
        } else {
            // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ —á–∞—Ç–∞
            const userName = userNameInput.value.trim();
            if (!chatName || !userName) return;
            
            try {
                const response = await fetch('/api/v1/chats/new_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ chat_name: chatName, user_name: userName })
                });
                
                if (response.status === 401) {
                    window.location.href = '../../autentifications/index.html';
                    return;
                }
                
                if (response.ok) {
                    closeCreateModal();
                    await loadChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞:', error);
            }
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞
    openSettingsBtn.addEventListener('click', () => {
        if (!currentChatUuid) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
            return;
        }
        settingsModalBackdrop.style.display = 'flex';
        const modal = settingsModalBackdrop.querySelector('.modal');
        setTimeout(() => modal.classList.add('open'), 10);
    });

    function closeSettingsModal() {
        const modal = settingsModalBackdrop.querySelector('.modal');
        modal.classList.remove('open');
        setTimeout(() => settingsModalBackdrop.style.display = 'none', 250);
    }

    closeSettingsBtn.addEventListener('click', closeSettingsModal);
    settingsModalBackdrop.addEventListener('click', (e) => {
        if (e.target === settingsModalBackdrop) closeSettingsModal();
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
    deleteChatBtn.addEventListener('click', async () => {
        if (!currentChatUuid) return;
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/chats/delete_chat/${currentChatUuid}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                closeSettingsModal();
                chatWindow.classList.remove('active');
                currentChatUuid = null;
                if (currentWs) { // –ó–∞–∫—Ä—ã–≤–∞–µ–º WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
                    currentWs.close();
                    currentWs = null;
                }
                await loadChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞:', response.status);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
        }
    });
</script>

</body>
</html>
