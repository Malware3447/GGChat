<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGChat — Чат</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover: #005BBF;
            --background-light: #F9FAFB;
            --text-dark: #1E293B;
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08);
            --border-radius-large: 16px;
            --transition-speed: 0.25s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-dark); line-height: 1.6; }
        a { text-decoration: none; color: var(--primary-color); }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 5%; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary-color); cursor: pointer; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .icon-btn { height: 40px; width: 40px; display: grid; place-items: center; border-radius: 10px; border: 1px solid #E2E8F0; background: #fff; cursor: pointer; transition: background var(--transition-speed), transform var(--transition-speed), border-color var(--transition-speed); }
        .icon-btn:hover { background: #F8FAFC; transform: translateY(-1px); border-color: #D1D5DB; }

        .container { padding: 0 5% 40px; }
        .chat-head { display: flex; align-items: center; justify-content: space-between; margin: 6px 0 16px; }
        .chat-head .left { display: flex; align-items: center; gap: 10px; }
        .title { font-size: 22px; font-weight: 800; }
        .subtitle { color: #64748B; font-size: 14px; }

        .chat { background: #fff; border-radius: var(--border-radius-large); box-shadow: var(--shadow-light); min-height: calc(100vh - 190px); display: grid; grid-template-rows: 1fr auto; border: 1px solid #E2E8F0; }
        .messages { padding: 18px; overflow: auto; }
        .message-empty { margin: 20px; padding: 16px; border: 1px dashed #CBD5E1; border-radius: 12px; color: #64748B; text-align: center; }
        .composer { display: flex; gap: 10px; padding: 14px; border-top: 1px solid #E2E8F0; }
        .input { flex: 1; padding: 12px 14px; border: 1px solid #E2E8F0; border-radius: 12px; font-size: 16px; }
        .send { background: var(--primary-color); color: #fff; border: none; padding: 12px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .send:hover { background: var(--primary-hover); }

        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35); display: none; align-items: center; justify-content: center; z-index: 40; }
        .modal { width: 100%; max-width: 460px; background: #fff; border-radius: 16px; box-shadow: var(--shadow-light); padding: 22px; transform: translateY(10px); opacity: 0; transition: opacity var(--transition-speed), transform var(--transition-speed); }
        .modal.open { transform: translateY(0); opacity: 1; }
        .modal-title { font-weight: 800; font-size: 18px; margin-bottom: 12px; }
        .row { display: flex; align-items: center; gap: 10px; margin: 10px 0 2px; }
        .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; background: #F1F5F9; border: 1px solid #E2E8F0; border-radius: 8px; padding: 8px 10px; color: #0F172A; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn { padding: 10px 14px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
        .btn.secondary { background: #F1F5F9; color: #0F172A; }
        .btn.primary { background: var(--primary-color); color: #fff; }
        .btn.primary:hover { background: var(--primary-hover); }
        .danger { background: #EF4444; color: #fff; }
        .danger:hover { background: #DC2626; }
        .modal-actions { display: flex; gap: 10px; justify-content: space-between; margin-top: 14px; }
        .left-actions { display: flex; gap: 10px; }

        @media (max-width: 720px) {
            .header { padding: 16px 18px; }
            .container { padding: 0 18px 28px; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="logo" id="go-home">GGChat</div>
    <div class="actions">
        <button id="open-settings" class="icon-btn" title="Настройки">
            <!-- simple gear icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#0F172A" stroke-width="1.5"/>
                <path d="M19.4 13.5a7.6 7.6 0 0 0 .05-3l2.02-1.53-2-3.46-2.44.6a7.63 7.63 0 0 0-2.6-1.5L12 1.5 9.57 4.1a7.63 7.63 0 0 0-2.6 1.5l-2.44-.6-2 3.46 2.02 1.53a7.6 7.6 0 0 0 0 3L2.53 15l2 3.46 2.44-.6c.78.62 1.66 1.12 2.6 1.5L12 22.5l2.43-2.6c.94-.38 1.82-.88 2.6-1.5l2.44.6 2-3.46-2.02-1.54Z" stroke="#94A3B8" stroke-width="1.2"/>
            </svg>
        </button>
    </div>
</header>

<main class="container">
    <div class="chat-head">
        <div class="left">
            <button id="go-back" class="icon-btn" title="К списку чатов" aria-label="Назад к списку чатов">
                <!-- left arrow icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M15 19l-7-7 7-7" stroke="#0F172A" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div>
                <div class="title" id="chat-title">Чат</div>
                <div class="subtitle" id="chat-subtitle">Загрузка…</div>
            </div>
        </div>
        <div></div>
    </div>

    <section class="chat">
        <div class="messages" id="messages">
            <div class="message-empty">Сообщений пока нет. Напишите первое сообщение ниже.</div>
        </div>
        <form class="composer" id="composer">
            <input id="message-input" class="input" type="text" placeholder="Напишите сообщение…" autocomplete="off">
            <button class="send" type="submit">Отправить</button>
        </form>
    </section>
</main>

<!-- Modal: settings -->
<div id="modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <div class="modal-title" id="settings-title">Настройки чата</div>

        <div class="modal-actions">
            <div class="left-actions">
                <button id="delete-chat" class="btn danger">Удалить чат</button>
            </div>
            <div>
                <button id="close-settings" class="btn primary">Готово</button>
            </div>
        </div>
    </div>
</div>



    <script>
        // Получение UUID чата из URL
        const urlParams = new URLSearchParams(window.location.search);
        const chatUuid = urlParams.get('uuid');

        // Элементы DOM
        const goBackBtn = document.getElementById('go-back');
        const chatTitle = document.getElementById('chat-title');
        const chatSubtitle = document.getElementById('chat-subtitle');
        const chatIdBox = document.getElementById('chat-id-box');
        const copyIdBtn = document.getElementById('copy-id');
        const openSettingsBtn = document.getElementById('open-settings');
        const closeSettingsBtn = document.getElementById('close-settings');
        const deleteChatBtn = document.getElementById('delete-chat');
        const modalBackdrop = document.getElementById('modal-backdrop');

        // Переход к списку чатов
        goBackBtn.addEventListener('click', () => {
            if (typeof router !== 'undefined') {
                router.navigate('/chats');
            } else {
                window.location.href = '../all_chats/allchat.html';
            }
        });

        // Открытие модального окна настроек
        openSettingsBtn.addEventListener('click', () => {
            modalBackdrop.style.display = 'flex';
            const modal = modalBackdrop.querySelector('.modal');
            setTimeout(() => {
                modal.classList.add('open');
            }, 10);
        });

        // Закрытие модального окна настроек
        function closeSettingsModal() {
            const modal = modalBackdrop.querySelector('.modal');
            modal.classList.remove('open');
            setTimeout(() => {
                modalBackdrop.style.display = 'none';
            }, 250);
        }

        // Закрытие модального окна по кнопке "Готово"
        closeSettingsBtn.addEventListener('click', closeSettingsModal);

        // Закрытие модального окна по клику на backdrop
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeSettingsModal();
            }
        });

        // Копирование UUID чата
        copyIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(chatUuid)
                .then(() => {
                    // Временно меняем текст кнопки
                    const originalText = copyIdBtn.textContent;
                    copyIdBtn.textContent = 'Скопировано!';
                    setTimeout(() => {
                        copyIdBtn.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Ошибка при копировании UUID:', err);
                });
        });

        // Удаление чата
        deleteChatBtn.addEventListener('click', async () => {
            if (!confirm('Вы уверены, что хотите удалить этот чат? Это действие нельзя отменить.')) {
                return;
            }
            
            try {
                // Отправка DELETE запроса для удаления чата
                const response = await fetch(`/api/v1/chats/delete_chat/${chatUuid}`, {
                    method: 'DELETE',
                    credentials: 'include' // Включаем cookie в запрос
                });
                
                if (response.ok) {
                    // Переход к списку чатов после успешного удаления
                    if (typeof router !== 'undefined') {
                        router.navigate('/chats');
                    } else {
                        window.location.href = '../all_chats/allchat.html';
                    }
                } else {
                    console.error('Ошибка при удалении чата:', response.status);
                    alert('Ошибка при удалении чата');
                }
            } catch (error) {
                console.error('Ошибка при удалении чата:', error);
                alert('Ошибка при удалении чата');
            }
        });

        // Загрузка информации о чате
        async function loadChatInfo() {
            if (!chatUuid) {
                chatTitle.textContent = 'Ошибка';
                chatSubtitle.textContent = 'Не указан UUID чата';
                return;
            }
            
            try {
                // Отправка GET запроса для получения списка всех чатов
                const response = await fetch('/api/v1/chats/all_chats', {
                    credentials: 'include' // Включаем cookie в запрос
                });
                
                if (response.ok) {
                    const chats = await response.json();
                    // Поиск текущего чата по UUID
                    const currentChat = chats.find(chat => chat.uuid === chatUuid);
                    
                    if (currentChat) {
                        // Отображение информации о чате
                        chatTitle.textContent = currentChat.name;
                        chatSubtitle.textContent = `Чат создан`;
                        chatIdBox.textContent = currentChat.uuid;
                    } else {
                        chatTitle.textContent = 'Чат не найден';
                        chatSubtitle.textContent = 'Чат с таким UUID не существует';
                        chatIdBox.textContent = chatUuid;
                    }
                } else {
                    console.error('Ошибка при загрузке информации о чате:', response.status);
                    chatTitle.textContent = 'Ошибка загрузки';
                    chatSubtitle.textContent = 'Не удалось загрузить информацию о чате';
                    chatIdBox.textContent = chatUuid;
                }
            } catch (error) {
                console.error('Ошибка при загрузке информации о чате:', error);
                chatTitle.textContent = 'Ошибка загрузки';
                chatSubtitle.textContent = 'Не удалось загрузить информацию о чате';
                chatIdBox.textContent = chatUuid;
            }
        }

        // Загрузка информации о чате при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadChatInfo);
    </script>
</body>
</html>

